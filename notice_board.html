<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunkidi Notice Board</title>
    <style>
       body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f9f9f9;
    color: #333;
    height: 100%;
    display: flex;
    flex-direction: column;
}

        #header {
            height: auto; /* Adjust height to fit content */
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #header h2 {
            margin: 0;
            font-size: 1.5em;
            color: #00796b;
        }

        #authorNameContainer {
            margin-top: 10px;
        }

        #authorNameContainer label {
            margin-right: 5px;
        }

        #authorName {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }

/* Ensure the notice board takes up remaining space */
#noticeBoard {
    flex: 1; /* Take up remaining space */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent scrolling on the entire notice board */
}

        #noticesContainer {
            flex: 1; /* Take up all available space in the notice board */
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow-y: auto; /* Enable vertical scrolling */
        }

/* Keep the message typing box visible */
#postNoticeForm {
    height: auto; /* Adjust height to fit content */
    padding: 10px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: sticky; /* Keep it fixed at the bottom */
    bottom: 0; /* Stick to the bottom of the viewport */
}

        .messageRow {
            display: flex;
            gap: 10px;
        }

        #noticeContent {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
        }

        #postNoticeForm button {
            padding: 5px 10px;
            background-color: #00796b;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #message {
            /* margin-top: 10px; */
            font-size: 0.9em;
            color: red;
        }

        .notice {
            width: 70%;
            margin-right: auto;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
        }

        .my_notice {
            width: 70%;
            margin-left: auto;
            background-color: #e8f5e9;
            border-right: 4px solid #4caf50;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
            text-align: right;
        }

        .notice .author, .my_notice .author {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85em;
            color: #555;
        }

        .notice .timestamp, .my_notice .timestamp {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div id="header">
        <h2>Sunkidi Notice Board</h2>

        <div id="authorNameContainer">
            <label for="authorName">Name:</label>
            <input type="text" id="authorName" placeholder="Your Name" required>
        </div>
    </div>

    <div id="noticeBoard">
        <div id="noticesContainer"></div>
    </div>

    <form id="postNoticeForm">
        <div class="messageRow">
            <textarea id="noticeContent" rows="2" placeholder="Write your notice here..." required></textarea>
            <button type="submit">âž¤</button>
        </div>
    </form>

    <script>
        function generateTimestamp() {
        const now = new Date();
        return now.toISOString().replace('T', ' ').substring(0, 19); // Format as "yyyy-MM-dd HH:mm:ss"
    }

    function generateUUID() {
        return crypto.randomUUID(); // Generate a unique ID
    }

        let lastRowNumber = 0;
        let uuids = new Set();

        const noticesContainer = document.getElementById('noticesContainer');
        const postNoticeForm = document.getElementById('postNoticeForm');
        const authorNameInput = document.getElementById('authorName');
        const noticeContentInput = document.getElementById('noticeContent');
        const messageDiv = document.getElementById('message');
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbx0BTH66hmLvmJfSWCkm2go4FQDcwhZ2_3_6ITiPl_ctXp9xyQxHNzay_ageWmnAqu7/exec';

        const fixedColors = [
            '#8B4513', '#556B2F', '#4682B4', '#6A5ACD', '#708090',
            '#2F4F4F', '#8B0000', '#B8860B', '#A0522D', '#5F9EA0',
            '#7B68EE', '#483D8B', '#2E8B57', '#4B0082', '#696969',
            '#8B008B', '#9932CC', '#8FBC8F', '#778899', '#6B8E23'
        ];

        const userColorMap = new Map();

        function generateRandomSuffix() {
            return Math.random().toString(36).substring(2, 6);
        }

        function initializeAuthorName() {
            if (!localStorage.getItem('authorName')) {
                const defaultName = `User_${generateRandomSuffix()}`;
                localStorage.setItem('authorName', defaultName);
            }
            authorNameInput.value = localStorage.getItem('authorName');
        }

        function saveAuthorName() {
            localStorage.setItem('authorName', authorNameInput.value.trim());
        }

        function getColorForUser(username) {
            if (!userColorMap.has(username)) {
                const colorIndex = userColorMap.size % fixedColors.length;
                userColorMap.set(username, fixedColors[colorIndex]);
            }
            return userColorMap.get(username);
        }

        function displayMessage(text, color = 'red') {
            messageDiv.textContent = text;
            messageDiv.style.color = color;
        }

        // if duplicate id, then return none
        function createNoticeElement(row) {
            const [id, author, content, timestamp] = row; // Destructure the row
            if (uuids.has(id)) {
                return null; // Skip if the ID already exists
            }
            uuids.add(id); // Add the ID to the set

            const noticeDiv = document.createElement('div');
            const isCurrentUser = author === localStorage.getItem('authorName');
            noticeDiv.className = isCurrentUser ? 'my_notice' : 'notice';

            const authorColor = getColorForUser(author);
            noticeDiv.innerHTML = `
                <div class="author" style="color: ${authorColor};">~${author}</div>
                <p>${content}</p>
                <div class="timestamp">${timestamp}</div>
            `;
            return noticeDiv;
        }

        function scrollToBottom() {
            noticesContainer.scrollTop = noticesContainer.scrollHeight;
        }

        function fetchNotices() {
            return fetch(`${webAppUrl}?action=getNotices&lastRowNumber=${lastRowNumber}`)
                .then(response => response.json())
                .then(data => {
                    lastRowNumber = data.lastRowNumber; // Update the last row number
                    console.log('Last Row Number:', lastRowNumber);
                    // Process the 2D array
                    const noticesArray = data.data; // Extract the 2D array
                    noticesArray.forEach(row => {
                        const noticeElement = createNoticeElement(row);
                        if (noticeElement) {
                            noticesContainer.appendChild(noticeElement);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching notices:', error);
                    displayMessage('Failed to load notices. Please try again later.');
                });
        }


// post then fetch 
function postNotice(author, content) {
        const formData = new URLSearchParams();
        formData.append('id', generateUUID()); // Generate ID on the frontend
        formData.append('timestamp', generateTimestamp()); // Generate timestamp on the frontend
        formData.append('author', author);
        formData.append('content', content);

        fetch(`${webAppUrl}?action=postNotice`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                noticeContentInput.value = '';
                fetchNotices().then(() => {
                    scrollToBottom(); // Scroll after notices are fetched and rendered
                });
            } else {
                displayMessage(data.error || 'Failed to post notice.');
            }
        })
        .catch(error => {
            console.error('Error posting notice:', error);
            displayMessage('Failed to post notice. Please try again later.');
        });
    }




        postNoticeForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const author = authorNameInput.value.trim();
            const content = noticeContentInput.value.trim();

            if (author && content) {
                postNotice(author, content);
            } else {
                displayMessage('Please enter your name and the notice content.', 'orange');
            }
        });

        authorNameInput.addEventListener('input', saveAuthorName);


        initializeAuthorName();

        fetchNotices().then(() => {
            scrollToBottom(); // Scroll to the bottom after fetching notices
        });

        // setInterval(fetchNotices, 10000);
        setInterval(() => {
            fetchNotices().then(() => {
                scrollToBottom(); // Scroll to the bottom after fetching notices
            });
        }, 20000); // Fetch every 20 seconds
    </script>

</body>
</html>