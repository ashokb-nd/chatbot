<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunkidi Notice Board</title>
    <style>
       body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f9f9f9;
    color: #333;
    height: 100%;
    display: flex;
    flex-direction: column;
}

        #header {
            height: auto; /* Adjust height to fit content */
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #header h2 {
            margin: 0;
            font-size: 1.5em;
            color: #00796b;
        }

        #authorNameContainer {
            margin-top: 10px;
        }

        #authorNameContainer label {
            margin-right: 5px;
        }

        #authorName {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }

/* Ensure the notice board takes up remaining space */
#noticeBoard {
    flex: 1; /* Take up remaining space */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent scrolling on the entire notice board */
}

        #noticesContainer {
            flex: 1; /* Take up all available space in the notice board */
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow-y: auto; /* Enable vertical scrolling */
        }

/* Keep the message typing box visible */
#postNoticeForm {
    height: auto; /* Adjust height to fit content */
    padding: 10px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: sticky; /* Keep it fixed at the bottom */
    bottom: 0; /* Stick to the bottom of the viewport */
}

        .messageRow {
            display: flex;
            gap: 10px;
        }

        #noticeContent {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            max-height: 200px; /* Set a maximum height */
            overflow-y: auto; /* Add a scrollbar if the content exceeds max height */
        }

        #postNoticeForm button {
            padding: 5px 10px;
            background-color: #00796b;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #message {
            /* margin-top: 10px; */
            font-size: 0.9em;
            color: red;
        }

        .notice {
            width: 70%;
            margin-right: auto;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
            /* text-align: left; */
        }

        .my_notice {
            width: 70%;
            margin-left: auto;
            background-color: #e8f5e9;
            border-right: 4px solid #4caf50;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
            /* text-align: left; */
        }

        .notice p, .my_notice p {
        white-space: pre-wrap; /* Preserve new lines and whitespace */
        margin: 0; /* Remove default margin for paragraphs */
        }

        .notice .author, .my_notice .author {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85em;
            color: #555;
        }

        .notice .timestamp, .my_notice .timestamp {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }

        /* Add styles for the tick mark */
        .tick {
            font-size: 0.8em;
            color: #4caf50; /* Green color for the tick */
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <audio id="post_audio" src="https://ashokbatakala.github.io/assets/img/outside_files/message_sent.mp3"></audio>
    <script>
        const audio = document.getElementById('post_audio');
        audio.onerror = () => {
            console.error('Audio failed to load. Check the file format or URL.');
        };
    </script>
    <div id="header">
        <h2>Sunkidi Notice Board</h2>

        <div id="authorNameContainer">
            <label for="authorName">Name:</label>
            <input type="text" id="authorName" placeholder="Your Name" required>
        </div>
    </div>

    <div id="noticeBoard">
        <div id="noticesContainer"></div>
    </div>


    <form id="postNoticeForm">
        <div id="message"></div>
        <div class="messageRow">
            <textarea id="noticeContent" rows="2" placeholder="Write your notice here..." required></textarea>
            <button type="submit">➤</button>
        </div>
    </form>


    <script>
        function generateTimestamp() {
        const now = new Date();
        return now.toISOString().replace('T', ' ').substring(0, 19); // Format as "yyyy-MM-dd HH:mm:ss"
    }

    function generateUUID() {
        return crypto.randomUUID(); // Generate a unique ID
    }

        let lastRowNumber = 0;
        let uuids = new Set();

        const noticesContainer = document.getElementById('noticesContainer');
        const postNoticeForm = document.getElementById('postNoticeForm');
        const authorNameInput = document.getElementById('authorName');
        const noticeContentInput = document.getElementById('noticeContent');
        const messageDiv = document.getElementById('message');
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbx0BTH66hmLvmJfSWCkm2go4FQDcwhZ2_3_6ITiPl_ctXp9xyQxHNzay_ageWmnAqu7/exec';

        const fixedColors = [
            '#8B4513', '#556B2F', '#4682B4', '#6A5ACD', '#708090',
            '#2F4F4F', '#8B0000', '#B8860B', '#A0522D', '#5F9EA0',
            '#7B68EE', '#483D8B', '#2E8B57', '#4B0082', '#696969',
            '#8B008B', '#9932CC', '#8FBC8F', '#778899', '#6B8E23'
        ];

        const userColorMap = new Map();

        function generateRandomSuffix() {
            return Math.random().toString(36).substring(2, 6);
        }

        function initializeAuthorName() {
            if (!localStorage.getItem('authorName')) {
                const defaultName = `User_${generateRandomSuffix()}`;
                localStorage.setItem('authorName', defaultName);
            }
            authorNameInput.value = localStorage.getItem('authorName');
        }

        function saveAuthorName() {
            localStorage.setItem('authorName', authorNameInput.value.trim());
        }

        function getColorForUser(username) {
            if (!userColorMap.has(username)) {
                const colorIndex = userColorMap.size % fixedColors.length;
                userColorMap.set(username, fixedColors[colorIndex]);
            }
            return userColorMap.get(username);
        }

        function displayMessage(text, color = 'red') {
            
            // display for 3 seconds
            messageDiv.innerHTML = `<span style="color: ${color}; text-align: center; display: block;">${text}</span>`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 30000);

        }

        // if duplicate id, then return none
        function createNoticeElement(row) {
            const [id, author, content, timestamp] = row; // Destructure the row
            if (uuids.has(id)) {
                return null; // Skip if the ID already exists
            }
            uuids.add(id); // Add the ID to the set

            const noticeDiv = document.createElement('div');
            const isCurrentUser = author === localStorage.getItem('authorName');
            noticeDiv.className = isCurrentUser ? 'my_notice' : 'notice';

            const authorColor = getColorForUser(author);
            noticeDiv.innerHTML = `
                <div class="author" style="color: ${authorColor};">~${author}</div>
                <p>${content}</p>
                <div class="timestamp">
                    ${timestamp}
                    ${isCurrentUser ? '<span class="tick" style="display: none;">✔</span>' : ''}
                </div>
            `;
            return noticeDiv;
        }

        function scrollToBottom() {
            noticesContainer.scrollTop = noticesContainer.scrollHeight;
        }

    function fetchNotices() {
        return fetch(`${webAppUrl}?action=getNotices&lastRowNumber=${lastRowNumber}`)
        .then(response => response.json())
        .then(data => {
            // console.log(data);
            lastRowNumber = data.lastRowNumber;
            const noticesArray = data.data;
            if (noticesArray.length === 0) {
                displayMessage('No new notices available.', 'orange');
                return;
            }
            const fragment = document.createDocumentFragment();
            noticesArray.forEach(row => {
                const noticeElement = createNoticeElement(row);
                if (noticeElement) {
                    fragment.appendChild(noticeElement);
                }
            });
            noticesContainer.appendChild(fragment);
        })
        .catch(error => {
            console.error('Error fetching notices:', error);
            displayMessage('Failed to load notices. Please try again later.');
        });
    }


function postNotice(author, content) {
    if (content.length > 1000) {
        displayMessage('Notice content exceeds 1000 characters. Please split it into multiple posts.', 'orange');
        return;
    }

    const id = generateUUID(); // Generate ID on the frontend
    const timestamp = generateTimestamp(); // Generate timestamp on the frontend

    // Optimistically add the notice to the UI
    const noticeElement = createNoticeElement([id, author, content, timestamp]);
    if (noticeElement) {
        noticesContainer.appendChild(noticeElement);
        scrollToBottom(); // Scroll to the bottom after adding the new notice
    }

    // Temporarily store the content in case of an error
    const previousContent = content;

    // Clear the input field immediately
    noticeContentInput.value = '';

    const formData = new URLSearchParams();
    formData.append('id', id);
    formData.append('timestamp', timestamp);
    formData.append('author', author);
    formData.append('content', content);

    fetch(`${webAppUrl}?action=postNotice`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            // Remove the optimistically added notice if the server returns an error
            uuids.delete(id); // Remove the ID from the set
            noticesContainer.removeChild(noticeElement);
            displayMessage(data.error || 'Failed to post notice.');

            // Repopulate the input field with the previous content
            noticeContentInput.value = previousContent;
        } else {
            // Play the audio on successful post
            audio.currentTime = 0; // Reset audio to start
            audio.play();

            // Show the tick mark to indicate success
            const tickElement = noticeElement.querySelector('.tick');
            if (tickElement) {
                tickElement.style.display = 'inline'; // Make the tick visible
            }
        }
    })
    .catch(error => {
        console.error('Error posting notice:', error);
        // Remove the optimistically added notice if there's a network error
        uuids.delete(id); // Remove the ID from the set
        noticesContainer.removeChild(noticeElement);
        displayMessage('Failed to post notice. Please try again later.');

        // Repopulate the input field with the previous content
        noticeContentInput.value = previousContent;
    });
}


        // Handle form submission
        postNoticeForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            noticeContentInput.focus(); // Focus on the textarea
            const author = authorNameInput.value.trim();
            const content = noticeContentInput.value.trim();

            if (author && content) {
                postNotice(author, content);
            } else {
                displayMessage('Please enter your name.', 'orange');
            }
        });

        // Save author name to local storage when the input changes
        let saveAuthorNameTimeout;
        authorNameInput.addEventListener('input', () => {
            clearTimeout(saveAuthorNameTimeout);
            saveAuthorNameTimeout = setTimeout(saveAuthorName, 300);
        });


        initializeAuthorName();

        fetchNotices().then(() => {
            scrollToBottom(); // Scroll to the bottom after fetching notices
        });

        // setInterval(fetchNotices, 10000);
        setInterval(() => {
            fetchNotices().then(() => {
                scrollToBottom(); // Scroll to the bottom after fetching notices
            });
        }, 180000); // Fetch every 20 seconds


// const noticeContentInput = document.getElementById('noticeContent');

// Function to auto-resize the textarea
function autoResizeTextarea() {
    this.style.height = 'auto'; // Reset height to calculate the new height
    this.style.height = Math.min(this.scrollHeight, 200) + 'px'; // Set height to scrollHeight, with a max height of 200px
}

// Attach the auto-resize function to the input event
noticeContentInput.addEventListener('input', autoResizeTextarea);
    </script>

</body>
</html>
``` 