<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunkidi Notice Board</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #header {
            height: auto;
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #header h2 {
            margin: 0;
            font-size: 1.5em;
            color: #00796b;
        }

        #authorNameContainer {
            margin-top: 10px;
        }

        #authorNameContainer label {
            margin-right: 5px;
        }

        #authorName {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }

        #noticeBoard {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #noticesContainer {
            flex: 1;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow-y: auto;
        }

        #postNoticeForm {
            height: auto;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: sticky;
            bottom: 0;
        }

        .messageRow {
            display: flex;
            gap: 10px;
        }

        #noticeContent {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            max-height: 200px;
            overflow-y: auto;
        }

        #postNoticeForm button {
            padding: 5px 10px;
            background-color: #00796b;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #message {
            font-size: 0.9em;
            color: red;
        }

        .notice {
            width: 70%;
            margin-right: auto;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
        }

        .my_notice {
            width: 70%;
            margin-left: auto;
            background-color: #e8f5e9;
            border-right: 4px solid #4caf50;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
        }

        .notice, .my_notice {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .notice p, .my_notice p {
            white-space: pre-wrap;
            margin: 0;
        }

        .notice .author, .my_notice .author {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85em;
            color: #555;
        }

        .notice .timestamp, .my_notice .timestamp {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }

        .tick {
            font-size: 0.8em;
            color: #4caf50;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <audio id="post_audio" src="https://ashokbatakala.github.io/assets/img/outside_files/message_sent.mp3"></audio>
    <script>
        const audio = document.getElementById('post_audio');
        audio.onerror = () => {
            console.error('Audio failed to load. Check the file format or URL.');
        };
    </script>
    <div id="header">
        <h2>Sunkidi Notice Board</h2>
        <div id="authorNameContainer">
            <label for="authorName">Name:</label>
            <input type="text" id="authorName" placeholder="Your Name" required>
        </div>
    </div>
    <div id="noticeBoard">
        <div id="noticesContainer"></div>
    </div>
    <form id="postNoticeForm">
        <div id="message"></div>
        <div class="messageRow">
            <textarea id="noticeContent" rows="2" placeholder="Write your notice here..." required></textarea>
            <button type="submit">➤</button>
        </div>
    </form>
    <script>
        function generateTimestamp() {
            const now = new Date();
            return now.toISOString().replace('T', ' ').substring(0, 19);
        }

        function generateUUID() {
            return crypto.randomUUID();
        }

        let lastRowNumber = 0;
        let uuids = new Set();

        const noticesContainer = document.getElementById('noticesContainer');
        const postNoticeForm = document.getElementById('postNoticeForm');
        const authorNameInput = document.getElementById('authorName');
        const noticeContentInput = document.getElementById('noticeContent');
        const messageDiv = document.getElementById('message');
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbx0BTH66hmLvmJfSWCkm2go4FQDcwhZ2_3_6ITiPl_ctXp9xyQxHNzay_ageWmnAqu7/exec';

        const fixedColors = [
            '#8B4513', '#556B2F', '#4682B4', '#6A5ACD', '#708090',
            '#2F4F4F', '#8B0000', '#B8860B', '#A0522D', '#5F9EA0',
            '#7B68EE', '#483D8B', '#2E8B57', '#4B0082', '#696969',
            '#8B008B', '#9932CC', '#8FBC8F', '#778899', '#6B8E23'
        ];

        const userColorMap = new Map();

        function generateRandomSuffix() {
            return Math.random().toString(36).substring(2, 6);
        }

        function initializeAuthorName() {
            if (!localStorage.getItem('authorName')) {
                const defaultName = `User_${generateRandomSuffix()}`;
                localStorage.setItem('authorName', defaultName);
            }
            authorNameInput.value = localStorage.getItem('authorName');
        }

        function saveAuthorName() {
            localStorage.setItem('authorName', authorNameInput.value.trim());
        }

        function getColorForUser(username) {
            if (!userColorMap.has(username)) {
                const colorIndex = userColorMap.size % fixedColors.length;
                userColorMap.set(username, fixedColors[colorIndex]);
            }
            return userColorMap.get(username);
        }

        function displayMessage(text, color = 'red') {
            messageDiv.innerHTML = `<span style="color: ${color}; text-align: center; display: block;">${text}</span>`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 30000);
        }

        function createNoticeElement(row) {
            const [id, author, content, timestamp] = row;
            if (uuids.has(id)) {
                return null;
            }
            uuids.add(id);

            const noticeDiv = document.createElement('div');
            const isCurrentUser = author === localStorage.getItem('authorName');
            noticeDiv.className = isCurrentUser ? 'my_notice' : 'notice';

            const authorColor = getColorForUser(author);
            noticeDiv.innerHTML = `
                <div class="author" style="color: ${authorColor};">~${author}</div>
                <p>${content}</p>
                <div class="timestamp">
                    ${timestamp}
                    ${isCurrentUser ? '<span class="tick" style="display: none;">✔</span>' : ''}
                </div>
            `;
            return noticeDiv;
        }

        function scrollToBottom() {
            noticesContainer.scrollTop = noticesContainer.scrollHeight;
        }

        function fetchNotices() {
            return fetch(`${webAppUrl}?action=getNotices&lastRowNumber=${lastRowNumber}`)
                .then(response => response.json())
                .then(data => {
                    lastRowNumber = data.lastRowNumber;
                    const noticesArray = data.data;
                    if (noticesArray.length === 0) {
                        displayMessage('No new notices available.', 'orange');
                        return false;
                    }
                    const fragment = document.createDocumentFragment();
                    noticesArray.forEach(row => {
                        const noticeElement = createNoticeElement(row);
                        if (noticeElement) {
                            fragment.appendChild(noticeElement);
                        }
                    });
                    noticesContainer.appendChild(fragment);
                    return true;
                })
                .catch(error => {
                    console.error('Error fetching notices:', error);
                    displayMessage('Failed to load notices. Please try again later.');
                    return false;
                });
        }

        function postNotice(author, content) {
            if (content.length > 1000) {
                displayMessage('Notice content exceeds 1000 characters. Please split it into multiple posts.', 'orange');
                return;
            }

            const id = generateUUID();
            const timestamp = generateTimestamp();

            const noticeElement = createNoticeElement([id, author, content, timestamp]);
            if (noticeElement) {
                noticesContainer.appendChild(noticeElement);
                scrollToBottom();
            }

            const previousContent = content;
            noticeContentInput.value = '';

            const formData = new URLSearchParams();
            formData.append('id', id);
            formData.append('timestamp', timestamp);
            formData.append('author', author);
            formData.append('content', content);

            fetch(`${webAppUrl}?action=postNotice`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        uuids.delete(id);
                        noticesContainer.removeChild(noticeElement);
                        displayMessage(data.error || 'Failed to post notice.');
                        noticeContentInput.value = previousContent;
                    } else {
                        audio.currentTime = 0;
                        audio.play();

                        const tickElement = noticeElement.querySelector('.tick');
                        if (tickElement) {
                            tickElement.style.display = 'inline';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error posting notice:', error);
                    uuids.delete(id);
                    noticesContainer.removeChild(noticeElement);
                    displayMessage('Failed to post notice. Please try again later.');
                    noticeContentInput.value = previousContent;
                });
        }

        postNoticeForm.addEventListener('submit', function(event) {
            event.preventDefault();
            noticeContentInput.focus();
            const author = authorNameInput.value.trim();
            const content = noticeContentInput.value.trim();

            if (author && content) {
                postNotice(author, content);
            } else {
                displayMessage('Please enter your name.', 'orange');
            }
        });

        let saveAuthorNameTimeout;
        authorNameInput.addEventListener('input', () => {
            clearTimeout(saveAuthorNameTimeout);
            saveAuthorNameTimeout = setTimeout(saveAuthorName, 300);
        });

        initializeAuthorName();

        fetchNotices().then(() => {
            scrollToBottom();
        });

        const scrollThreshold = 100;
        function scrolldown_if_close() {
            if (noticesContainer.scrollHeight - noticesContainer.scrollTop <= noticesContainer.clientHeight + scrollThreshold) {
                scrollToBottom();
            }
        }

        setInterval(() => {
            fetchNotices().then((fetched) => {
                if (fetched) {
                    scrolldown_if_close();
                }
            });
        }, 180000);

        function autoResizeTextarea() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        }

        noticeContentInput.addEventListener('input', autoResizeTextarea);
    </script>
</body>
</html>